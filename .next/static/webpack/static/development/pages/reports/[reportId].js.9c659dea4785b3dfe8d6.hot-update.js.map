{"version":3,"file":"static/webpack/static/development/pages/reports/[reportId].js.9c659dea4785b3dfe8d6.hot-update.js","sources":["webpack:///./client/Report/Report.tsx"],"sourcesContent":["\nimport { useReportGetQuery, useReportUpdateMutation, ChartFragment, ReportUpdateMutationVariables, ReportFragment, ReportGetDocument } from \"../codegen/graphql\";\nimport styled from \"@emotion/styled\";\nimport { ErrorBox } from \"../components/ErrorBox\";\nimport { Crumbs, CrumbTitle, CrumbLink } from \"../components/Crumbs\";\nimport { Header, HeaderSection } from \"../components/Header\";\nimport { Icon } from \"../components/Icon\";\nimport { FlatButton, Button } from \"../components/Button\";\nimport { useState, KeyboardEvent, useEffect } from \"react\";\nimport { css, keyframes } from \"@emotion/core\";\nimport { useMouseDrag, Pos } from \"../hooks/drag\";\nimport { colors } from \"../theme\";\nimport cuid from \"cuid\"\n\ntype Tool =\n  | \"insert_chart\"\n  | \"insert_image\"\n  | \"insert_text\"\n  | \"select\"\n\n\ntype Selection = ChartFragment\n\n\nconst removeTypename = (report: ReportFragment): ReportUpdateMutationVariables[\"report\"] => {\n  const { __typename, slides, ...reportData } = report;\n  return {\n    ...reportData,\n    slides: slides.map(({ __typename, charts, ...slideData }) => {\n      return {\n        ...slideData,\n        charts: charts.map(({ __typename, ...chartData }) => {\n          return chartData\n        })\n      }\n    })\n  }\n}\n\nconst getModifiers = (e: KeyboardEvent) =>\n  new Set([\n    e.nativeEvent.metaKey && \"meta\",\n    e.nativeEvent.ctrlKey && \"ctrl\",\n    e.nativeEvent.altKey && \"alt\",\n    e.nativeEvent.shiftKey && \"shift\",\n  ].filter(Boolean)\n  )\n\nexport const ReportPage = (props: { id: string, slide?: string }) => {\n  const [scale, setScale] = useState(1)\n\n\n  const [tool, setTool] = useState<Tool>(\"select\")\n  const [selection, setSelection] = useState<Selection[]>([])\n\n  const [undoHistory, setUndoHistory] = useState<ReportUpdateMutationVariables[\"report\"][]>([])\n  const [undoHistoryIndex, setUndoHistoryIndex] = useState<number>(0)\n\n  const reportQuery = useReportGetQuery({\n    variables: {\n      id: props.id\n    },\n    onCompleted: ({ report }) => {\n      setScale(window.innerWidth * 0.8 / report.width)\n    }\n  })\n\n  const report = reportQuery.data && reportQuery.data.report\n\n  useEffect(() => {\n    if (report && undoHistory.length === 0) {\n      setUndoHistory([report])\n    }\n  }, [report])\n\n  const [_updateReport, updateReportQuery] = useReportUpdateMutation()\n\n  const updateReport = (report: ReportUpdateMutationVariables[\"report\"], isUndo = false) => {\n    if (!isUndo) {\n      setUndoHistory([...undoHistory.slice(0, undoHistoryIndex + 1), report])\n      setUndoHistoryIndex(undoHistoryIndex + 1)\n\n    }\n    reportQuery.client.writeQuery({\n      query: ReportGetDocument,\n      variables: { id: report.id },\n      data: {\n        report\n      }\n    })\n    return _updateReport({\n      variables: {\n        report: removeTypename(report as ReportFragment)\n      }\n    })\n\n  }\n\n\n  useEffect(() => {\n    const handler = () => {\n      if (report) {\n\n        setScale(window.innerWidth * 0.8 / report.width)\n      }\n    }\n    window.addEventListener(\"resize\", handler);\n    return () => window.removeEventListener(\"resize\", handler)\n  }, [report])\n\n  const selectedSlide = report && (report.slides.find(s => s.id === props.slide) || report.slides[0]);\n\n  const getDragBox = (pos: Pos, origin: Pos) => {\n    return {\n      x: Math.min(pos.x, origin.x) / scale,\n      y: Math.min(pos.y, origin.y) / scale,\n      width: Math.abs(pos.x - origin.x) / scale,\n      height: Math.abs(pos.y - origin.y) / scale,\n    }\n  }\n\n  const { dragHandlers, dragPos, dragOrigin, isDragging, parentRef } = useMouseDrag({\n    onDragEnd: (pos, origin) => {\n      const box = getDragBox(pos, origin);\n      switch (tool) {\n        case \"insert_chart\": {\n\n          const newChart = {\n            id: cuid(),\n            x: Math.round(box.x),\n            y: Math.round(box.y),\n            width: Math.round(box.width),\n            height: Math.round(box.height),\n            __typename: \"Chart\" as \"Chart\"\n          }\n\n          const newReport = {\n            ...report,\n            slides: report.slides.map(slide => {\n              if (slide.id === selectedSlide.id) {\n                return {\n                  ...slide,\n                  charts: [...slide.charts, newChart]\n                }\n              } else {\n                return slide\n              }\n            })\n          }\n          updateReport(newReport)\n          setTool(\"select\");\n          setSelection([newChart])\n        }\n\n      }\n    }\n  })\n\n  console.log({ undoHistory })\n\n  return (\n    <Layout tabIndex={-1} onKeyDown={e => {\n      const modifiers = getModifiers(e);\n      switch (e.key) {\n        case \"Escape\":\n          setTool(\"select\")\n          if (tool === \"select\") {\n            setSelection([]);\n          }\n          return e.preventDefault();\n        case \"c\":\n          if (modifiers.size === 0) {\n            setTool(\"insert_chart\")\n            return e.preventDefault();\n          }\n        case \"i\":\n          if (modifiers.size === 0) {\n            setTool(\"insert_image\")\n            return e.preventDefault();\n          }\n        case \"t\":\n          if (modifiers.size === 0) {\n            setTool(\"insert_text\")\n            return e.preventDefault();\n          }\n        case \"Backspace\": {\n          updateReport({\n            ...report,\n            slides: report.slides.map(slide => ({\n              ...slide,\n              charts: slide.charts.filter(chart => selection.some(selection => selection.id === chart.id) === false)\n            }))\n          })\n        }\n        case \"z\":\n          if (modifiers.has(\"meta\") && modifiers.has(\"meta\") && undoHistory.length > undoHistoryIndex + 1) { // Redo\n            const newIndex = undoHistoryIndex + 1;\n            updateReport(undoHistory[newIndex], true);\n            setUndoHistoryIndex(newIndex)\n            return e.preventDefault();\n          }\n\n          if (modifiers.has(\"meta\") && undoHistoryIndex > 0) { // undo\n            const newIndex = undoHistoryIndex - 1;\n            updateReport(undoHistory[newIndex], true);\n            setUndoHistoryIndex(newIndex)\n            return e.preventDefault();\n          }\n\n      }\n    }}>\n      {(reportQuery.loading || updateReportQuery.loading) && <LoadingIndicator />}\n      <Header>\n        <HeaderSection>\n          <Crumbs>\n            <CrumbLink href=\"/\">Home</CrumbLink>\n            <CrumbLink href=\"/\">Reports</CrumbLink>\n            <CrumbTitle>{report ? report.title : \"...\"}</CrumbTitle>\n          </Crumbs >\n          <NewElements>\n            <FlatButton name=\"insert_chart\" onClick={() => setTool(\"insert_chart\")} active={tool === \"insert_chart\"}>\n              <Icon icon=\"insert_chart\" />\n            </FlatButton>\n            <FlatButton name=\"insert_image\" onClick={() => setTool(\"insert_image\")} active={tool === \"insert_image\"}><Icon icon=\"insert_photo\" /></FlatButton>\n            <FlatButton name=\"insert_text\" onClick={() => setTool(\"insert_text\")} active={tool === \"insert_text\"}><Icon icon=\"insert_text\" /></FlatButton>\n          </NewElements>\n        </HeaderSection>\n      </Header >\n      <div style={{ position: \"absolute\", bottom: 16, right: 16 }}>{scale}</div>\n      <Stage tool={tool} scale={scale}>\n\n        {\n          selectedSlide &&\n          <Slide ref={parentRef} {...dragHandlers} width={report.width} height={report.height}>\n            {[\"insert_chart\", \"insert_image\", \"insert_text\"].includes(tool) && isDragging &&\n              <DragBox {...getDragBox(dragPos, dragOrigin)} />\n            }\n            {selectedSlide.charts.map(chart => {\n              return (\n\n                <Chart key={chart.id} selected={selection.some(s => s.id === chart.id)} {...chart} onClick={e => {\n                  if (tool === \"select\") {\n                    setSelection(e.nativeEvent.shiftKey ? [...selection, chart] : [chart]);\n                  }\n                }} />\n              )\n            })}\n          </Slide>\n        }\n        {report && !selectedSlide &&\n          <Center>\n            <Button name=\"create slide\" onClick={() => {\n              updateReport({\n                ...report,\n                slides: [\n                  ...report.slides,\n                  { id: cuid(), charts: [] }\n                ]\n              })\n            }}>\n              Create You first Slide\n            </Button>\n          </Center>\n        }\n        {reportQuery.error && <ErrorBox error={reportQuery.error} />}\n      </Stage>\n\n    </Layout >\n  )\n}\n\nconst Chart = styled.div<ChartFragment & { selected: boolean }>`\n  position:absolute;\n  left: ${p => p.x}px;\n  top: ${p => p.y}px;\n  width: ${p => p.width}px;\n  height: ${p => p.height}px;\n  background: #f0f0f0;\n  border: 1px solid #dedede;\n  ${p => p.selected && css`border: 1px dashed ${colors.primary};`};\n`\n\n\nconst Center = styled.div`\n  height:100%;\n  display:grid;\n  place-content:center center;\n  `\n\n\ntype DragBoxProps = {\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n}\n\nconst DragBox = styled.div<DragBoxProps>`\n  position:absolute;\n  width:${p => p.width}px;\n  height:${p => p.height}px;\n  left:${p => p.x}px;\n  top:${p => p.y}px;\n  border: 2px dashed ${colors.primary};\n`\n\nconst Slide = styled.section<{ width: number, height: number }>`\n  position:relative;\n  background:white;\n  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.4);\n  width: ${p => p.width}px;\n  height:${p => p.height}px;\n`\n\nconst NewElements = styled.div`\n  display:grid;\n  grid-auto-flow: column;\n  grid-gap: 4px;\n  place-content: center start;\n`\n\n\nconst Layout = styled.div`\n  display:grid;\n  height:100%;\n  grid-gap: 32px;\n  background:#f5f5f5;\n  grid-template-rows: auto 1fr;\n  place-content: start stretch;\n  overflow:hidden;\n`\n\nconst Stage = styled.main<{ tool: Tool, scale: number }>`\n  display:grid;\n  width:100%;\n  place-content:center center;\n  overflow:hidden;\n  ${p => {\n    switch (p.tool) {\n      case \"insert_chart\":\n      case \"insert_image\":\n      case \"insert_text\":\n        return css`\n        cursor: crosshair;\n        `\n    }\n  }}\n  & > * {\n    transform: scale(${p => p.scale});\n    transform-origin: 50% 50%;\n  }\n`\n\n\nconst LoadingIndicator = () =>\n  <LoadingWrapper>\n    <LoadingDot delay={0}>.</LoadingDot>\n    <LoadingDot delay={200}>.</LoadingDot>\n    <LoadingDot delay={400}>.</LoadingDot>\n  </LoadingWrapper>\n\nconst jumpAnimation = keyframes`\n  from {\n    opacity:0;\n  }\n  to {\n    opacity:1;\n  }\n`\n\n\nconst LoadingWrapper = styled.div`\nposition:absolute;\n  top: 0px;\n  right: 32px;\n  font-size: 2.5rem;\n`\nconst LoadingDot = styled.span<{ delay: number }>`\n  animation:${jumpAnimation} 1s ease infinite;\n  animation-delay:${p => p.delay}ms;\n`"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAWA;AAAA;AAAA;AAAA;AACA;AACA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAEA;AAAA;AAAA;AACA;AAAA;AACA;AAJA;AAMA;AATA;AAWA;AACA;AACA;AAAA;AAAA;AACA;AAQA;AAAA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AASA;AACA;AACA;AADA;AAGA;AAAA;AACA;AACA;AANA;AASA;AAEA;AACA;AACA;AACA;AACA;AACA;AA1BA;AAAA;AAAA;AAAA;AACA;AA4BA;AAAA;AACA;AAAA;AACA;AACA;AAEA;AACA;AAAA;AACA;AACA;AAAA;AAAA;AACA;AACA;AADA;AAHA;AAOA;AACA;AACA;AADA;AADA;AAMA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AAAA;AACA;AAAA;AAAA;AACA;AAEA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAJA;AAMA;AACA;AAxEA;AA0EA;AACA;AACA;AAAA;AACA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AANA;AACA;AAQA;AAEA;AACA;AACA;AAEA;AAFA;AAIA;AACA;AACA;AACA;AAXA;AACA;AAYA;AACA;AACA;AACA;AA5BA;AA+BA;AAlCA;AAzEA;AAAA;AAAA;AAAA;AAAA;AACA;AA6GA;AAAA;AAAA;AAEA;AACA;AAAA;AACA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AAAA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAEA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAFA;AAAA;AAFA;AAOA;AACA;AAAA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AA7CA;AA+CA;AAjDA;AAAA;AAAA;AAAA;AAAA;AAAA;AAkDA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAIA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAIA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AAJA;AAAA;AAAA;AAAA;AAAA;AAAA;AAMA;AAIA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AACA;AAEA;AAEA;AAAA;AAAA;AAJA;AAOA;AARA;AAAA;AAAA;AAAA;AAAA;AAAA;AAaA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAKA;AACA;AACA;AAAA;AAAA;AAAA;AAEA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AAGA;AAAA;AACA;AADA;AAAA;AAAA;AACA;AAGA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAaA;AAAA;AAAA;AAAA;AAEA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAAA;AACA;AAGA;AAAA;AAAA;AAAA;AAIA;AAAA;AACA;AAAA;AACA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAOA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;;;;;;;AASA;AAAA;AAAA;AAAA;AAMA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAJA;AAQA;AAEA;AAAA;AACA;AAKA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAJA;AACA;AAMA;AACA;AASA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAKA;AAAA;AAAA;AAAA;AAEA;AAAA;;;;A","sourceRoot":""}