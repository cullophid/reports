{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime-corejs2/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nvar _jsxFileName = \"/Users/andreasmoller/code/reports/client/components/Page.tsx\";\nvar __jsx = React.createElement;\nimport { jsx as ___EmotionJSX } from \"@emotion/core\";\nimport ApolloClient, { InMemoryCache } from \"apollo-boost\";\nimport fetch from \"isomorphic-fetch\";\nimport { ApolloProvider } from \"@apollo/react-hooks\";\nimport { useMemo, createContext, useState, useEffect } from \"react\";\nimport React from 'react';\nimport { Global, css } from \"@emotion/core\";\nimport Router from \"next/router\";\nvar globalStyles =\n/*#__PURE__*/\nprocess.env.NODE_ENV === \"production\" ? {\n  name: \"j8dkh7-globalStyles\",\n  styles: \"html,body,#__next{margin:0;padding:0;height:100%;}a,a:hover,a:visited{text-decoration:none;color:inherit;}*{box-sizing:border-box;}label:globalStyles;\"\n} : {\n  name: \"j8dkh7-globalStyles\",\n  styles: \"html,body,#__next{margin:0;padding:0;height:100%;}a,a:hover,a:visited{text-decoration:none;color:inherit;}*{box-sizing:border-box;}label:globalStyles;\",\n  map: \"/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbmRyZWFzbW9sbGVyL2NvZGUvcmVwb3J0cy9jbGllbnQvY29tcG9uZW50cy9QYWdlLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFRd0IiLCJmaWxlIjoiL1VzZXJzL2FuZHJlYXNtb2xsZXIvY29kZS9yZXBvcnRzL2NsaWVudC9jb21wb25lbnRzL1BhZ2UudHN4Iiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEFwb2xsb0NsaWVudCwgeyBPcGVyYXRpb24sIEluTWVtb3J5Q2FjaGUgfSBmcm9tIFwiYXBvbGxvLWJvb3N0XCI7XG5pbXBvcnQgZmV0Y2ggZnJvbSBcImlzb21vcnBoaWMtZmV0Y2hcIjtcbmltcG9ydCB7IEFwb2xsb1Byb3ZpZGVyIH0gZnJvbSBcIkBhcG9sbG8vcmVhY3QtaG9va3NcIjtcbmltcG9ydCB7IFJlYWN0Q2hpbGQsIHVzZU1lbW8sIGNyZWF0ZUNvbnRleHQsIHVzZVN0YXRlLCB1c2VFZmZlY3QgfSBmcm9tIFwicmVhY3RcIjtcbmltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCdcbmltcG9ydCB7IEdsb2JhbCwgY3NzIH0gZnJvbSBcIkBlbW90aW9uL2NvcmVcIlxuaW1wb3J0IFJvdXRlciBmcm9tIFwibmV4dC9yb3V0ZXJcIjtcblxuY29uc3QgZ2xvYmFsU3R5bGVzID0gY3NzYFxuICBodG1sLCBib2R5LCAjX19uZXh0IHtcbiAgICBtYXJnaW46MDtcbiAgICBwYWRkaW5nOjA7XG4gICAgaGVpZ2h0OjEwMCU7XG4gIH1cbiAgYSwgYTpob3ZlciwgYTp2aXNpdGVkIHtcbiAgICB0ZXh0LWRlY29yYXRpb246bm9uZTtcbiAgICBjb2xvcjppbmhlcml0O1xuICAgIFxuICB9XG4gICoge1xuICAgIGJveC1zaXppbmc6Ym9yZGVyLWJveDtcbiAgfVxuYFxuXG50eXBlIFByb3BzID0ge1xuICBjaGlsZHJlbjogUmVhY3RDaGlsZDtcbiAgcmVxdWlyZUF1dGg6IGJvb2xlYW5cbn1cblxuY29uc3QgQXV0aENvbnRleHQgPSBjcmVhdGVDb250ZXh0PHN0cmluZyB8IG51bGw+KHVuZGVmaW5lZClcblxuXG5cbmV4cG9ydCBjb25zdCBmZXRjaEF1dGhUb2tlbiA9IGFzeW5jICgpID0+IHtcbiAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2goXCIvYXBpL3JlZnJlc2hfdG9rZW5cIilcbiAgaWYgKHJlcy5zdGF0dXMgIT09IDIwMCkge1xuICAgIFJvdXRlci5wdXNoKFwiL2xvZ2luXCIpXG4gIH1cbiAgY29uc3QgeyBhdXRoX3Rva2VuIH0gPSBhd2FpdCByZXMuanNvbigpXG4gIGNvbnNvbGUubG9nKHsgYXV0aF90b2tlbiB9KVxuICByZXR1cm4gYXV0aF90b2tlblxufVxuXG5jb25zdCBqd3RQcm9taXNlID0gZmV0Y2hBdXRoVG9rZW4oKVxuXG5leHBvcnQgY29uc3QgUGFnZSA9ICh7IHJlcXVpcmVBdXRoLCBjaGlsZHJlbiB9OiBQcm9wcykgPT4ge1xuXG4gIGNvbnN0IFthdXRoVG9rZW4sIHNldEF1dGhUb2tlbl0gPSB1c2VTdGF0ZTxzdHJpbmcgfCBudWxsPihudWxsKVxuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgand0UHJvbWlzZVxuICAgICAgLnRoZW4oc2V0QXV0aFRva2VuKVxuICAgIGNvbnN0IGludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgZmV0Y2hBdXRoVG9rZW4oKVxuICAgICAgICAudGhlbihzZXRBdXRoVG9rZW4pXG4gICAgfSwgNSAqIDYwICogMTAwMClcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbClcbiAgICB9XG4gIH0sIFtdKVxuXG5cbiAgY29uc3QgYXBvbGxvQ2xpZW50ID0gdXNlTWVtbygoKSA9PiBuZXcgQXBvbGxvQ2xpZW50KHtcbiAgICB1cmk6IFwiL2FwaS9ncmFwaHFsXCIsXG4gICAgcmVxdWVzdDogYXN5bmMgKG9wZXJhdGlvbjogT3BlcmF0aW9uKSA9PiB7XG4gICAgICBpZiAoYXV0aFRva2VuKSB7XG4gICAgICAgIG9wZXJhdGlvbi5zZXRDb250ZXh0KHtcbiAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7YXV0aFRva2VufWBcbiAgICAgICAgICB9LFxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIGlmIChyZXF1aXJlQXV0aCkge1xuICAgICAgICBjb25zdCBhdXRoVG9rZW4gPSBhd2FpdCBqd3RQcm9taXNlXG4gICAgICAgIG9wZXJhdGlvbi5zZXRDb250ZXh0KHtcbiAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7YXV0aFRva2VufWBcbiAgICAgICAgICB9LFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0sXG4gICAgb25FcnJvcjogKHsgcmVzcG9uc2UsIG9wZXJhdGlvbiB9KSA9PiB7XG4gICAgICBpZiAocmVzcG9uc2UgJiYgcmVzcG9uc2UuZXJyb3JzKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IocmVzcG9uc2UsIG9wZXJhdGlvbik7XG4gICAgICB9XG4gICAgfSxcbiAgICBjYWNoZTogbmV3IEluTWVtb3J5Q2FjaGUoe1xuICAgICAgZGF0YUlkRnJvbU9iamVjdDogb2JqZWN0ID0+IG9iamVjdC5pZCxcbiAgICB9KSxcbiAgICBmZXRjaCxcbiAgfSksIFthdXRoVG9rZW5dKVxuICByZXR1cm4gKFxuICAgIDxBdXRoQ29udGV4dC5Qcm92aWRlciB2YWx1ZT17YXV0aFRva2VufT5cbiAgICAgIDxBcG9sbG9Qcm92aWRlciBjbGllbnQ9e2Fwb2xsb0NsaWVudH0+XG4gICAgICAgIDxHbG9iYWwgc3R5bGVzPXtnbG9iYWxTdHlsZXN9IC8+XG4gICAgICAgIHtjaGlsZHJlbn1cbiAgICAgIDwvQXBvbGxvUHJvdmlkZXIgPlxuICAgIDwvQXV0aENvbnRleHQuUHJvdmlkZXI+XG4gIClcbn1cbiJdfQ== */\"\n};\nvar AuthContext = createContext(undefined);\nexport var fetchAuthToken =\n/*#__PURE__*/\nfunction () {\n  var _ref = _asyncToGenerator(\n  /*#__PURE__*/\n  _regeneratorRuntime.mark(function _callee() {\n    var res, _ref2, auth_token;\n\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            _context.next = 2;\n            return fetch(\"/api/refresh_token\");\n\n          case 2:\n            res = _context.sent;\n\n            if (res.status !== 200) {\n              Router.push(\"/login\");\n            }\n\n            _context.next = 6;\n            return res.json();\n\n          case 6:\n            _ref2 = _context.sent;\n            auth_token = _ref2.auth_token;\n            console.log({\n              auth_token: auth_token\n            });\n            return _context.abrupt(\"return\", auth_token);\n\n          case 10:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n\n  return function fetchAuthToken() {\n    return _ref.apply(this, arguments);\n  };\n}();\nvar jwtPromise = fetchAuthToken();\nexport var Page = function Page(_ref3) {\n  var requireAuth = _ref3.requireAuth,\n      children = _ref3.children;\n\n  var _useState = useState(null),\n      authToken = _useState[0],\n      setAuthToken = _useState[1];\n\n  useEffect(function () {\n    jwtPromise.then(setAuthToken);\n    var interval = setInterval(function () {\n      fetchAuthToken().then(setAuthToken);\n    }, 5 * 60 * 1000);\n    return function () {\n      clearInterval(interval);\n    };\n  }, []);\n  var apolloClient = useMemo(function () {\n    return new ApolloClient({\n      uri: \"/api/graphql\",\n      request: function () {\n        var _request = _asyncToGenerator(\n        /*#__PURE__*/\n        _regeneratorRuntime.mark(function _callee2(operation) {\n          var _authToken;\n\n          return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n            while (1) {\n              switch (_context2.prev = _context2.next) {\n                case 0:\n                  if (!authToken) {\n                    _context2.next = 4;\n                    break;\n                  }\n\n                  operation.setContext({\n                    headers: {\n                      Authorization: \"Bearer \".concat(authToken)\n                    }\n                  });\n                  _context2.next = 9;\n                  break;\n\n                case 4:\n                  if (!requireAuth) {\n                    _context2.next = 9;\n                    break;\n                  }\n\n                  _context2.next = 7;\n                  return jwtPromise;\n\n                case 7:\n                  _authToken = _context2.sent;\n                  operation.setContext({\n                    headers: {\n                      Authorization: \"Bearer \".concat(_authToken)\n                    }\n                  });\n\n                case 9:\n                case \"end\":\n                  return _context2.stop();\n              }\n            }\n          }, _callee2);\n        }));\n\n        function request(_x) {\n          return _request.apply(this, arguments);\n        }\n\n        return request;\n      }(),\n      onError: function onError(_ref4) {\n        var response = _ref4.response,\n            operation = _ref4.operation;\n\n        if (response && response.errors) {\n          console.error(response, operation);\n        }\n      },\n      cache: new InMemoryCache({\n        dataIdFromObject: function dataIdFromObject(object) {\n          return object.id;\n        }\n      }),\n      fetch: fetch\n    });\n  }, [authToken]);\n  return ___EmotionJSX(AuthContext.Provider, {\n    value: authToken,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 92\n    },\n    __self: this\n  }, ___EmotionJSX(ApolloProvider, {\n    client: apolloClient,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 93\n    },\n    __self: this\n  }, ___EmotionJSX(Global, {\n    styles: globalStyles,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 94\n    },\n    __self: this\n  }), children));\n};","map":{"version":3,"sources":["/Users/andreasmoller/code/reports/client/components/Page.tsx"],"names":["ApolloClient","InMemoryCache","fetch","ApolloProvider","useMemo","createContext","useState","useEffect","React","Global","css","Router","globalStyles","AuthContext","undefined","fetchAuthToken","res","status","push","json","auth_token","console","log","jwtPromise","Page","requireAuth","children","authToken","setAuthToken","then","interval","setInterval","clearInterval","apolloClient","uri","request","operation","setContext","headers","Authorization","onError","response","errors","error","cache","dataIdFromObject","object","id"],"mappings":"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","sourcesContent":["import ApolloClient, { Operation, InMemoryCache } from \"apollo-boost\";\nimport fetch from \"isomorphic-fetch\";\nimport { ApolloProvider } from \"@apollo/react-hooks\";\nimport { ReactChild, useMemo, createContext, useState, useEffect } from \"react\";\nimport React from 'react'\nimport { Global, css } from \"@emotion/core\"\nimport Router from \"next/router\";\n\nconst globalStyles = css`\n  html, body, #__next {\n    margin:0;\n    padding:0;\n    height:100%;\n  }\n  a, a:hover, a:visited {\n    text-decoration:none;\n    color:inherit;\n    \n  }\n  * {\n    box-sizing:border-box;\n  }\n`\n\ntype Props = {\n  children: ReactChild;\n  requireAuth: boolean\n}\n\nconst AuthContext = createContext<string | null>(undefined)\n\n\n\nexport const fetchAuthToken = async () => {\n  const res = await fetch(\"/api/refresh_token\")\n  if (res.status !== 200) {\n    Router.push(\"/login\")\n  }\n  const { auth_token } = await res.json()\n  console.log({ auth_token })\n  return auth_token\n}\n\nconst jwtPromise = fetchAuthToken()\n\nexport const Page = ({ requireAuth, children }: Props) => {\n\n  const [authToken, setAuthToken] = useState<string | null>(null)\n\n  useEffect(() => {\n    jwtPromise\n      .then(setAuthToken)\n    const interval = setInterval(() => {\n      fetchAuthToken()\n        .then(setAuthToken)\n    }, 5 * 60 * 1000)\n    return () => {\n      clearInterval(interval)\n    }\n  }, [])\n\n\n  const apolloClient = useMemo(() => new ApolloClient({\n    uri: \"/api/graphql\",\n    request: async (operation: Operation) => {\n      if (authToken) {\n        operation.setContext({\n          headers: {\n            Authorization: `Bearer ${authToken}`\n          },\n        })\n      } else if (requireAuth) {\n        const authToken = await jwtPromise\n        operation.setContext({\n          headers: {\n            Authorization: `Bearer ${authToken}`\n          },\n        })\n      }\n    },\n    onError: ({ response, operation }) => {\n      if (response && response.errors) {\n        console.error(response, operation);\n      }\n    },\n    cache: new InMemoryCache({\n      dataIdFromObject: object => object.id,\n    }),\n    fetch,\n  }), [authToken])\n  return (\n    <AuthContext.Provider value={authToken}>\n      <ApolloProvider client={apolloClient}>\n        <Global styles={globalStyles} />\n        {children}\n      </ApolloProvider >\n    </AuthContext.Provider>\n  )\n}\n"]},"metadata":{},"sourceType":"module"}